FROM node:20-bookworm-slim

ENV PNPM_HOME=/pnpm
ENV PATH=$PNPM_HOME:$PATH

WORKDIR /app

RUN corepack enable && corepack prepare pnpm@10.28.2 --activate

COPY package.json pnpm-lock.yaml tsconfig.json ./
COPY scripts ./scripts
COPY programs/orderbook/orderbook.idl ./programs/orderbook/orderbook.idl
COPY programs/vault/vault.idl ./programs/vault/vault.idl

RUN pnpm install --frozen-lockfile

RUN useradd --create-home --shell /usr/sbin/nologin appuser \
    && chown appuser:appuser /app

USER appuser

EXPOSE 4180

CMD ["pnpm", "demo:ui"]
